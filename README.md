# DQPSK_plus_Freq



## Описание проекта
Прошивка для ручного прибора, используемого для проверки присутствующих на линии кодов АРСФ и АРС

## Используемые компоненты
Программа написана для платы Geehy APM32F407IG miniboard. Для нормальной работы подразумевается наличие USART приёмника, модифицированной платы МСД-Т (далее - МСД-ТМ) и
LCD экрана 3.5inch RPi LCD (A), управляемый контроллером ILI9488. МСД-ТМ используется для прибавления к входному сигналу постоянной компоненты. Также используются источники питания на 14В и 5В для питания платы МСД-ТМ и Geehy miniboard соответственно

## Подключение

Плата Geehy miniboard запитывается через USB Type B коннектор, JTAG интерфейс подключается к пинам **PA14** (SWCLK), **PB3** (SWDO) и **GND**. Используемые для этого пины дублируются на блоке контактов J5 (так удобнее). Подключение периферии описывается далее.

### USART:

Rx -> **PA9**

Tx -> **PA10**

GND -> **GND**

```
Параметры USART подключения:
- Baud rate     115200
- Data bits     8
- Stop bits     1
- Parity        None
``` 

### МСД-ТМ:

Входной сигнал (желтый провод с 3.5мм mini-Jack) -> PC_AUDIO_OUTPUT

```
Входной сигнал также можно подать и с катушки. Для этого необходимо прицепить выходы катушки к двум площадкам 3.5мм коннектора крокодилами или снять коннектор и скрутить/припаять контакты 
```

Выходной сигнал (черно-белый провод с 3.5мм mini-Jack):
- Сигнал (первая площадка, считая от кончика коннектора) -> **PA0**
- Земля (последняя площадка) -> **GND**

```
К коннектору выходного сигнала рекомендуется прицепляться крокодилами. Выход сделан таким образом, чтобы при помощи МСД-ТМ можно было записывать сигнал на линии при помощи ПК, поэтому снимать коннектор не рекомендуется
```

### LCD экран:

Экран подключается к контроллеру по шине SPI и контактами общего назначения

- Шина SPI:

    SCLK -> **PA5**

    MISO -> **PA6**

    MOSI -> **PA7**

    LCD_CS -> **PB1**

- Управляющие контакты:

    LCD_BL -> **PC4**

    LCD_RST -> **PC5**

    LCD_DC -> **PB0**
- Питание:

    5V -> **+5.0V**

    GND -> **GND** (достаточно подключить один из двух GND контактов)

Прошивка также может работать и без подключенного LCD, выходные данные можно принимать по USART

## Документация

Документация кода написана в doxygen формате. Стартовая html страница для просмотра - index.html

# Работа с устройством

Устройство имеет два режима работы: 
- АРСФ - режим дешифровки ФРМ кодов 
- АРС - режим частотного анализа, необходимый для определения кодов АРС

Переключение между режимами осуществляется нажатием на кнопку **KEY1**. Перед работой рекомендуется сбросить устройство (кнопка **RESET**)

Результаты анализа входного сигнала будут транслироваться в USART канал и на LCD дисплей.

## Выходные данные (LCD)

На стартовом экране после загрузки программы отображается информационное сообщение **НАЖМИТЕ KEY1**, далее, по нажатию KEY1, программа выводит результаты анализа по выбранному режиму работы:

- АРСФ:

    В режиме дешифровки ФРМ кодов информация отображается на экране в следующем формате:
    ```
    КОД: - полученный код в шестнадцатеричном формате
    КРЦ: - кодируемая рельсовая цепь, разрешенная скорость на данном участке цепи в км/ч
    СРЦ: - следующая рельсовая цепь, разрешенная скорость на следующем участке цепи в км/ч
    АМП: - амплитуда, средняя амплитуда полученного сигнала в вольтах
    ```
- АРС:
    
    АРС является менее информативным каналом связи, поэтому количество выводимой информации несколько меньше:
    ```
    КОД: - полученный код в герцах
    КРЦ: - кодируемая рельсовая цепь, разрешенная скорость на данном участке цепи в км/ч 
    АМП: - амплитуда, средняя амплитуда полученного сигнала в вольтах
    ```

На экране также отображается информация о выбранном режиме работы (АРС/АРСФ). Также, при отсутствии выходного сигнала (или невозможности его дешифровать) в значениях. Помимо этого, существуют также особые коды, это:
**0x00, 0x40, 0x80, 0xC0** в режиме АРСФ (отображается как **НК**) и **325** в режиме АРС (отображается как **ВРД**) 

## Выходные данные (USART)

В режиме определения кода ФРМ устройство формирует выходные данные в формате **XX** **С**, 
где XX - 16-ти ричный код, C - количество корректно дешифрованных кодов в посылке (5 максимум)  

```
Пример: сообщение C1 4 означает, что был принят код C1 с результатом 4/5 
```

В режиме частотного анализа устройство формирует выход в следующем виде:

```
 75 Hz ->   0.0 %
125 Hz -> 100.0 %
175 Hz ->   0.0 %
225 Hz ->   0.0 %
275 Hz ->   0.0 %
325 Hz ->   0.0 %
```
Такой выход означает, что на линии присутствует АРС сигнал с частотой 125 Гц.

Также, в обоих режимах работы устройство возвращает среднюю амплитуду полученного сигнала, например:

```
AVG: 2995.347 mV
```

По большому счету, USART канал дублирует (с некоторыми дополнениями) информацию, отображаемую на LCD экране, поэтому его наличие не обязательно

## Сигналы состояния системы

При возникновении различных ошибок системы и периферии, элемент, в котором возникла ошибка, перезагружается, информация о событии передаётся по USART. Возможные сообщения:

```
USART ERROR RESET - ошибка по шине USART
ADC ERROR RESET - ошибка приёма по АЦП
SPI ERROR RESET - ошибка по шине SPI
WDT SYSTEM RESET - перезагрузка системы, инициируется сторожевым таймером
```

Если устройству не получается восстановить работоспособность периферии в течении пяти раз подряд, то система уходит в принудительный сон и сигнализирует об этом следующим образом:

- Включены оба светодиода (LED2 и LED3)
- На линии ЦАП 3.3 V
- Экран LCD полностью закрашен в красный (тёмно-красный) цвет
- Было передано сообщение **SYSTEM FATAL ERROR** по USART

Далее перезагрузка возможна только вручную (кнопкой **RESET**)

Помимо этого, устройство также сигнализирует о своём состоянии светодиодами LED2 (желтый), LED3 (красный) и ЦАП (контакт **PA4**):

- Состояние ожидания (приёма) пакета:
    
    LED2 включен, LED3 выключен, на линии ЦАП низкий уровень напряжения (~0.1 V)

- Состояние обработки принятого сигнала:

    LED2 выключен, LED3 включен, на линии ЦАП высокий уровень напряжения (~3.3 V)

